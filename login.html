<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IISAQ Login</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --base-clr: #11121a;
            --line-clr: #42434a;
            --hover-clr: #222533;
            --text-clr: #e6e6ef;
            --acent-clr: #5e63ff;
            --secondary-text-clr: #b0b3c1;
            --btn-clr: hsl(240, 100%, 70%);
            --error-clr: #ff4757;
            --success-clr: #00b894;
            --current-accent: var(--acent-clr);
            --current-btn-clr: var(--btn-clr);
        }

        .teacher-theme { --current-accent: #00b894; --current-btn-clr: #00b894; }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--base-clr);
            color: var(--text-clr);
        }

        .login-container {
            background-color: var(--hover-clr);
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--line-clr);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #page-title { text-align: center; margin-bottom: 20px; font-size: 1.8em; color: var(--current-accent); }

        /* --- THE FORMAL MESSAGE BOX --- */
        #status-box {
            display: none;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            text-align: center;
            border: 1px solid transparent;
            animation: slideDown 0.3s ease;
        }

        .msg-error { background-color: rgba(255, 71, 87, 0.1); color: var(--error-clr); border-color: rgba(255, 71, 87, 0.3); }
        .msg-success { background-color: rgba(0, 184, 148, 0.1); color: var(--success-clr); border-color: rgba(0, 184, 148, 0.3); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--secondary-text-clr); font-size: 0.9em; }
        .input-group input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--line-clr);
            background: var(--base-clr); color: white; outline: none; transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--current-accent); }

        .submit-btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            background: var(--current-btn-clr); color: white; font-weight: 600; cursor: pointer;
        }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .forgot-password { text-align: center; margin-top: 15px; font-size: 0.85em; }
        .forgot-password a { color: var(--secondary-text-clr); text-decoration: none; }
    </style>
</head>
<body>

    <div class="login-container">
        <h1 id="page-title">IISAQ Login</h1>

        <div id="status-box"></div>

        <form class="login-form" id="loginForm">
            <div class="input-group">
                <label for="uid">User ID</label>
                <input type="text" id="uid" name="uid" placeholder="Enter your ID" autocomplete="off" required>
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" autocomplete="off" required>
            </div>
            
            <button type="submit" id="submitBtn" class="submit-btn">Login</button>

            <p class="forgot-password">
                <a href="https://mail.google.com/mail/u/0/#inbox?compose=GTvVlcSMVVvdtWgfvJmPkwbSbJbjDghjSRkpchlXfWztpKxXTwqdFpMWJwCvZjrbScGHwfSKSDtsv" target="_blank">Forgot Password?</a>
            </p>
        </form>
    </div>

    <script type="module">
        import { tl } from "./login/login.js";

        const urlParams = new URLSearchParams(window.location.search);
        const userType = urlParams.get('t');
        const statusBox = document.getElementById('status-box');
        const submitBtn = document.getElementById('submitBtn');
        const loginForm = document.getElementById('loginForm');
        
        let attempts = 0;
        const maxAttempts = 5;

        function showMessage(text, type = 'error') {
            statusBox.textContent = text;
            statusBox.className = type === 'success' ? 'msg-success' : 'msg-error';
            statusBox.style.display = 'block';
        }

        // Handle Theme/Redirects
        window.onload = () => {
            if (localStorage.getItem("lcds?t=s") && userType === "s") window.location.href = "stu/index.html";
            if (localStorage.getItem("lcds?t=t") && userType === "t") window.location.href = "teac/index.html";
        };

        if (userType === 't') {
            document.body.classList.add('teacher-theme');
            document.getElementById('page-title').textContent = 'Teacher Login';
        } else if (userType === 's') {
            document.getElementById('page-title').textContent = 'Student Login';
        } else {
            document.querySelector('.login-form').style.display = 'none';
            showMessage("Access Denied: Missing user type.", "error");
            setTimeout(() => window.location.href = "/", 3000);
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (attempts >= maxAttempts) {
                showMessage("Account temporarily locked. Too many attempts.", "error");
                return;
            }

            const sidValue = document.getElementById('uid').value;
            const pwdValue = document.getElementById('password').value;

            submitBtn.disabled = true;
            submitBtn.textContent = "Verifying...";

            const role = userType === 't' ? 'teach' : 'stud';
            const r = await tl(role, sidValue, pwdValue);

            if (r.status === "Fail") {
                attempts++;
                submitBtn.disabled = false;
                submitBtn.textContent = "Login";
                showMessage(`Login failed. ${maxAttempts - attempts} attempts left.`, "error");
            } else {
                showMessage("Success! Redirecting...", "success");
                r.data.password = "InvalidRequest"; // Hide password in storage
                localStorage.setItem(`lcds?t=${userType}`, JSON.stringify(r));
                setTimeout(() => {
                    window.location.href = userType === 't' ? "teac/index.html" : "stu/index.html";
                }, 800);
            }
        });
    </script>
</body>
</html>